# Internal registry

Configure internal registry.

## Configuration

The internal registry is managed by the `image-registry-operator` and configure by the CR `Config/imageregistry.operator.openshift.io/v1`.

```yaml
apiVersion: imageregistry.operator.openshift.io/v1
kind: Config
metadata:
  name: cluster
spec:
  managementState: Managed
  replicas: 1
```

### Storage

Many different storage backends can be configure for persistency (pvc, s3, azure, gcs and swift).

```yaml
spec:
  ...
  storage:
    pvc:
      claim: registry-images-0
```

### Public URL

Expose the registry out of the cluster by creating an Openshift `Route`.

```yaml
spec:
  ...
  # Autogenerated URL
  defaultRoute: true/false
  # Custom URL
  routes:
    name: public-access
    hostname: <registry-url>
    secretName: registry-url-cert
```

### Node placement

Select the nodes where the image registry pods will be running.

```yaml
spec:
  ...
  nodeSelector:
    node-role.kubernetes.io/infra: ""
```

## RBAC

Permissions to pull or push images in a namesapce from the registry is managed by `system:image-puller` and `system:image-builder` roles respectively.

### Authorization

To allow a service account, a user or a group of users to **pull images** in a namespace from the registry create the following `RoleBinding`.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: images-puller
  namespace: example-ns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:image-puller
subjects:
  - kind: ServiceAccount
    name: example-sa
    namespace: example-ns
```

To allow a service account, a user or a group of users to **push images** in a namespace from the registry create the following `RoleBinding`.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: images-builder
  namespace: example-ns
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:image-builder
subjects:
  - kind: ServiceAccount
    name: example-sa
    namespace: example-ns
```

### Authentication

Authenticate against the registry with the service account token.

```bash
REGISTRY_PROJECT="example-ns"
REGISTRY_USER="example-sa"
REGISTRY_PASS="$(oc get secret \
    $(oc get sa ${REGISTRY_USER} -o json -n ${REGISTRY_PROJECT} | jq -r '.secrets[] | select(.name|test(".token.")) | .name') \
    --output jsonpath="{.data.token}" \
    --namespace ${REGISTRY_PROJECT} | base64 -d)"

podman login -u ${REGISTRY_USER} -p ${REGISTRY_PASS} ${REGISTRY_URL} # --tls-verify=false
```

Push an image to the registry.

```bash
podman push localhost/example-image:v1.0.0 \
    ${REGISTRY_URL}/example-ns/example-image:v1.0.0 # --tls-verify=false
```

Use that image in a deployment.

```yaml
...
  spec:
    containers:
      - name: quarkus-example
        image: image-registry.openshift-image-registry.svc:5000/example-ns/example-image:v1.0.0
```

## Deployment

Apply the changes given by the previous configuration.

```bash
./install.sh
```

## References

- https://docs.openshift.com/container-platform/4.2/registry/securing-exposing-registry.html
- https://docs.openshift.com/container-platform/4.2/registry/configuring-registry-storage/configuring-registry-storage-baremetal.html
